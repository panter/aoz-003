wb.add_worksheet(name: 'Klienten') do |sheet|
  columns = [
    'AOZ Klienten ID', # field to be left empty, according to Sven Marti (AOZ)
    'ID',
    'ID Anrede',
    'Anrede',
    'ID Geschlecht',
    'Geschlecht', # will add transformed salutation here, because gender isn't in the model
    'Nachname',
    'Vorname',
    'PLZ',
    'Ort',
    'Geburtsdatum',
    'Alter',
    'Nationalität ISO Alpha2',
    'Nationalität',
    'ID Prozess',
    'Prozess',
    'Erstellt am',
    'Akzeptiert am',
    'Beendet am',
    'Abgelehnt am',
    'Fallführend',
    'ID Kostenträger',
    'Kostenträger',
    'Einsatz',    # field to be left empty, according to Sven Marti (AOZ)
    'ID Status',
    'Status',
    'Zeit (von Anmeldung bis Vermittlung in Tagen)',
    'Zeit'        # report creation time
  ]
  sheet.add_row(columns, style: header_style, height: 25)
  clients.each do |client|
    alter = client.birth_year.present? ? ((Date.current - client.birth_year) / 365).floor : ''
    zeit_anmeldung_vermittlung = if client.accepted_at.present?
                                   (client.accepted_at.to_date - client.created_at.to_date)
                                 end
    data = [
      '',                                       # 'AOZ Klienten ID',
      client.id,                                # 'ID',
      client.salutation,                        # 'ID Anrede',
      t("salutation.#{client.salutation}"),     # 'Anrede',
      client.gender,                            # 'ID Geschlecht',
      client.gender_t,                          # 'Geschlecht',
      client.contact.last_name,                 # 'Nachname',
      client.contact.first_name,                # 'Vorname',
      client.contact.postal_code,               # 'PLZ',
      client.contact.city,                      # 'Ort',
      client.birth_year,                        # 'Geburtsdatum',
      alter,                                    # 'Alter',
      client.nationality,                       # 'Nationalität ISO Alpha2',
      nationality_name(client.nationality),     # 'Nationalität',
      Client.acceptances[client.acceptance],    # 'ID Prozess'
      client.acceptance_t,                      # 'Prozess',
      client.created_at,                        # 'Erstellt am',
      client.accepted_at,                       # 'Akzeptiert am',
      client.resigned_at,                       # 'Beendet am',
      client.rejected_at,                       # 'Abgelehnt am',
      client.competent_authority,               # 'Fallführend',
      Client.cost_units[client.cost_unit],      # 'ID Kostenträger',
      client.cost_unit.present? ? client.cost_unit_t : '', # 'Kostenträger',
      '',                                       # 'Einsatz'
      client.active_inactive_key,               # 'ID Status'
      t("state.#{client.active_inactive_key}"), # 'Status',
      zeit_anmeldung_vermittlung,               # 'Zeit (von Anmeldung bis Vermittlung)',
      zeit                                      # 'Zeit'
    ]
    types = [
      nil,      # 'AOZ Klienten ID',
      :integer, # 'id',
      nil,      # 'ID Anrede',
      nil,      # 'Anrede',
      nil,      # 'ID Geschlecht',
      nil,      # 'Geschlecht',
      nil,      # 'Nachname',
      nil,      # 'Vorname',
      nil,      # 'PLZ',
      nil,      # 'Ort',
      nil,      # 'Geburtsdatum',
      :integer, # 'Alter',
      nil,      # 'Nationalität ISO Alpha2',
      nil,      # 'Nationalität',
      :integer, # 'ID Prozess'
      nil,      # 'Prozess',
      :time,    # 'Erstellt am',
      :time,    # 'Akzeptiert am',
      :time,    # 'Beendet am',
      :time,    # 'Abgelehnt am',
      nil,      # 'Fallführend',
      :integer, # 'ID Kostenträger',
      nil,      # 'Kostenträger',
      nil,      # 'Einsatz',
      nil,      # 'ID Status'
      nil,      # 'Status',
      :integer, # 'Zeit (von Anmeldung bis Vermittlung)',
      :time     # 'Zeit'
    ]

    style = [
      standard_format,  # 'AOZ Klienten ID',
      standard_format,  # 'id',
      standard_format,  # 'ID Anrede',
      standard_format,  # 'Anrede',
      standard_format,  # 'ID Geschlecht',
      standard_format,  # 'Geschlecht',
      standard_format,  # 'Nachname',
      standard_format,  # 'Vorname',
      standard_format,  # 'PLZ',
      standard_format,  # 'Ort',
      date_format,      # 'Geburtsdatum',
      standard_format,  # 'Alter',
      standard_format,  # 'Nationalität ISO Alpha2',
      standard_format,  # 'Nationalität',
      standard_format,  # 'ID Prozess'
      standard_format,  # 'Prozess',
      date_time_format, # 'Erstellt am',
      date_time_format, # 'Akzeptiert am',
      date_time_format, # 'Beendet am',
      date_time_format, # 'Abgelehnt am',
      standard_format,  # 'Fallführend',
      standard_format,  # 'ID Kostenträger',
      standard_format,  # 'Kostenträger',
      standard_format,  # 'Einsatz',
      standard_format,  # 'ID Status'
      standard_format,  # 'Status',
      standard_format,  # 'Zeit (von Anmeldung bis Vermittlung)',
      date_time_format  # 'Zeit'
    ]
    sheet.add_row(data, types: types, style: style)
  end

  sheet.auto_filter = "A1:#{col_alpha_indexes[columns.size - 1]}#{clients.count + 1}"
  sheet.sheet_view.pane do |pane|
    pane.top_left_cell = 'A2'
    pane.state = :frozen_split
    pane.y_split = 1
    pane.x_split = 0
    pane.active_pane = :bottom_right
  end
end
